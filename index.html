<!-- æª”åï¼šindex.html (Source: SeafoodBossApp_v6.3.html) -->
<!-- ç‰ˆæœ¬ï¼šv6.3 (Sticky Header + Better Nav + Data Safe) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SEAFOOD.BOSS</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F8FAFC"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sky: { 50: '#F0F9FF', 100: '#E0F2FE', 500: '#0EA5E9', 600: '#0284C7' },
                        rose: { 50: '#FFF1F2', 500: '#F43F5E' },
                        orange: { 50: '#FFF7ED', 400: '#FB923C', 500: '#F97316' },
                        slate: { 50: '#F8FAFC', 100: '#F1F5F9', 400: '#94A3B8', 600: '#475569', 700: '#334155' },
                    },
                    boxShadow: {
                        'soft': '0 8px 30px -4px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 20px rgba(14, 165, 233, 0.25)',
                    },
                    animation: {
                        'pop': 'pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)',
                    },
                    keyframes: {
                        pop: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8FAFC;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            user-select: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); box-shadow: 0 -4px 20px rgba(0,0,0,0.03); }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Sticky Header Fix */
        .sticky-wrapper { position: sticky; top: 56px; z-index: 40; background-color: #F8FAFC; padding-bottom: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Database (CRITICAL: Must match v4.8) ---
        const DB_TASKS = 'sb_tasks_v1';
        const DB_TRANS = 'sf_transactions'; // Key for financial data
        const DB_LOGS = 'sf_logs';
        const DB_SETTINGS = 'sf_settings';
        const DB_ENV = 'sf_daily_env';

        // --- Utils ---
        const getToday = () => new Date().toISOString().split('T')[0];
        const formatTime = () => new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute:'2-digit' });
        const getCalendarDays = (year, month) => {
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const days = [];
            for(let i=0; i<firstDay.getDay(); i++) days.push(null);
            for(let i=1; i<=lastDay.getDate(); i++) days.push({ day: i, dateStr: `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}` });
            return days;
        };
        const useVoiceInput = (onResult) => {
            const [isListening, setIsListening] = useState(false);
            const startListening = () => {
                if (!('webkitSpeechRecognition' in window)) { alert("ä¸æ”¯æ´èªéŸ³è¼¸å…¥"); return; }
                const recognition = new window.webkitSpeechRecognition();
                recognition.lang = 'zh-TW'; recognition.continuous = false; recognition.interimResults = false;
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (event) => { onResult(event.results[0][0].transcript); };
                recognition.start();
            };
            return { isListening, startListening };
        };

        // --- Components ---

        // 1. Header (Floating)
        const Header = () => (
            <div className="fixed top-0 left-0 right-0 z-50 glass safe-top border-b border-slate-100/50">
                <div className="h-14 flex items-center justify-between px-6">
                    <div className="flex items-center gap-2">
                        <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center text-white shadow-glow">
                            <i className="fa-solid fa-fish text-sm"></i>
                        </div>
                        <span className="font-bold text-slate-700 text-lg tracking-tight">SEAFOOD<span className="text-sky-500">.BOSS</span></span>
                    </div>
                    <div className="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-full">v6.3</div>
                </div>
            </div>
        );

        // 2. Back Button (Enhanced UX)
        const BackBtn = ({ onClick }) => (
            <button onClick={onClick} className="flex items-center gap-2 bg-sky-100/50 hover:bg-sky-100 text-sky-600 px-4 py-2 rounded-full transition-colors mb-6 active:scale-95">
                <i className="fa-solid fa-chevron-left text-xs"></i>
                <span className="text-sm font-bold">è¿”å›æˆ°æƒ…</span>
            </button>
        );

        // 3. Dashboard Grid
        const DashboardGrid = ({ setPage, tasksCount }) => (
            <div className="h-full flex flex-col justify-center px-6 gap-4 animate-pop max-w-md mx-auto">
                <div className="grid grid-cols-2 gap-4 h-40">
                    <button onClick={() => setPage('todo')} className="bg-rose-50 rounded-3xl p-5 flex flex-col justify-between items-start text-left active:scale-95 transition-transform shadow-soft">
                        <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-rose-500 shadow-sm"><i className="fa-solid fa-check text-lg"></i></div>
                        <div><div className="text-2xl font-black text-slate-700">{tasksCount}</div><div className="text-xs font-bold text-rose-500 opacity-80">ä»Šæ—¥é‡é»</div></div>
                    </button>
                    <button onClick={() => setPage('ops')} className="bg-sky-50 rounded-3xl p-5 flex flex-col justify-between items-start text-left active:scale-95 transition-transform shadow-soft">
                        <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-sky-600 shadow-sm"><i className="fa-solid fa-calculator text-lg"></i></div>
                        <div><div className="text-lg font-black text-slate-700">å…§éƒ¨ç‡Ÿé‹</div><div className="text-xs font-bold text-sky-600 opacity-80">è²¡å‹™å ±è¡¨</div></div>
                    </button>
                </div>
                <div className="grid grid-cols-2 gap-4 h-40">
                    <button onClick={() => setPage('timer')} className="bg-orange-50 rounded-3xl p-5 flex flex-col justify-between items-start text-left active:scale-95 transition-transform shadow-soft">
                        <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-orange-500 shadow-sm"><i className="fa-solid fa-stopwatch text-lg"></i></div>
                        <div><div className="text-lg font-black text-slate-700">æš«é›¢æé†’</div><div className="text-xs font-bold text-orange-500 opacity-80">è¨ˆæ™‚æ¨¡å¼</div></div>
                    </button>
                    <button onClick={() => setPage('note')} className="bg-slate-100 rounded-3xl p-5 flex flex-col justify-between items-start text-left active:scale-95 transition-transform shadow-soft">
                        <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-slate-600 shadow-sm"><i className="fa-solid fa-pen text-lg"></i></div>
                        <div><div className="text-lg font-black text-slate-700">ç‡Ÿé‹ç­†è¨˜</div><div className="text-xs font-bold text-slate-500 opacity-80">éš¨æ‰‹è¨˜</div></div>
                    </button>
                </div>
            </div>
        );

        // 4. Sub Pages
        const TodoPage = ({ goBack }) => {
            const [tasks, setTasks] = useState([]);
            const [input, setInput] = useState('');
            const [tab, setTab] = useState('today');
            useEffect(() => { const s=localStorage.getItem(DB_TASKS); if(s) setTasks(JSON.parse(s)); }, []);
            const save = (n) => { setTasks(n); localStorage.setItem(DB_TASKS, JSON.stringify(n)); };
            const add = (t) => { if(!t.trim()) return; save([{id:Date.now(), text:t, done:false, tab}, ...tasks]); setInput(''); };
            const list = tasks.filter(t => t.tab === tab);
            return (
                <div className="pt-20 px-6 min-h-screen bg-white animate-pop pb-32">
                    <BackBtn onClick={goBack} />
                    <div className="flex items-center mb-6"><h2 className="text-2xl font-black text-slate-700">ä»Šæ—¥é‡é»</h2></div>
                    <div className="flex bg-slate-100 p-1 rounded-xl mb-6">{['today','tomorrow'].map(t=><button key={t} onClick={()=>setTab(t)} className={`flex-1 py-2 rounded-lg text-xs font-bold ${tab===t?'bg-white text-rose-500 shadow-sm':'text-slate-400'}`}>{t==='today'?'ä»Šæ—¥ç«ç·š':'æ˜æ—¥é æ’'}</button>)}</div>
                    <div className="space-y-3">{list.map(t=>(<div key={t.id} className="flex items-center p-3 rounded-xl border border-slate-50 shadow-sm bg-white"><button onClick={()=>save(tasks.map(i=>i.id===t.id?{...i,done:!i.done}:i))} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3 ${t.done?'bg-rose-500 border-rose-500':'border-slate-200'}`}>{t.done&&<i className="fa-solid fa-check text-white text-xs"></i>}</button><span className={`flex-1 text-sm font-bold ${t.done?'text-slate-300 line-through':'text-slate-700'}`}>{t.text}</span><button onClick={()=>save(tasks.filter(i=>i.id!==t.id))} className="text-slate-300"><i className="fa-solid fa-trash"></i></button></div>))}</div>
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-100 flex gap-2"><input value={input} onChange={e=>setInput(e.target.value)} placeholder="æ–°å¢ä»»å‹™..." className="flex-1 bg-slate-50 rounded-xl px-4 py-3 text-sm focus:outline-none" /><button onClick={()=>add(input)} className="w-12 rounded-xl bg-rose-500 text-white"><i className="fa-solid fa-plus"></i></button></div>
                </div>
            );
        };

        const OperationsPage = ({ goBack, transactions, setTransactions, settings, saveSettings, envData, setEnvData }) => {
            const [period, setPeriod] = useState('day'); 
            const [showAddModal, setShowAddModal] = useState(false);
            const [showSettingModal, setShowSettingModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [isCalExpanded, setIsCalExpanded] = useState(true);
            const [selectedDate, setSelectedDate] = useState(getToday());
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);
            
            const [date, setDate] = useState(getToday());
            const [type, setType] = useState('income');
            const [amount, setAmount] = useState('');
            const [cat, setCat] = useState('ç¾é‡‘');
            const [note, setNote] = useState('');
            const [tempFixedCost, setTempFixedCost] = useState(settings.dailyFixedCost || '');
            const [selectedCostItems, setSelectedCostItems] = useState(settings.costItems || []);

            // Logic copied from v4.8
            const toggleCostItem = (item) => { if(selectedCostItems.includes(item)) setSelectedCostItems(selectedCostItems.filter(i => i !== item)); else setSelectedCostItems([...selectedCostItems, item]); };
            const currentEnv = envData[selectedDate] || { weather: 'sunny', traffic: 'normal' };
            const updateEnv = (key, value) => { const newEnv = { ...envData, [selectedDate]: { ...currentEnv, [key]: value } }; setEnvData(newEnv); localStorage.setItem(DB_ENV, JSON.stringify(newEnv)); };

            const stats = useMemo(() => {
                const now = new Date(); const yearStr = now.getFullYear().toString(); const monthStr = `${yearStr}-${String(currentMonth).padStart(2, '0')}`;
                let filtered = [], fixedCostTotal = 0, listData = [], net = 0, income = 0, expense = 0;
                const dailyStats = {}; transactions.forEach(t => { if(!dailyStats[t.date]) dailyStats[t.date] = { income: 0, expense: 0 }; if(t.type === 'income') dailyStats[t.date].income += t.amount; else dailyStats[t.date].expense += t.amount; });
                const dailyCost = settings.dailyFixedCost || 0;
                if (period === 'day') { filtered = transactions.filter(t => t.date === selectedDate); fixedCostTotal = dailyCost; listData = filtered; } 
                else if (period === 'month') { filtered = transactions.filter(t => t.date.startsWith(monthStr)); const daysInM = new Date(now.getFullYear(), currentMonth, 0).getDate(); fixedCostTotal = dailyCost * daysInM; listData = transactions.filter(t => t.date === selectedDate); } 
                else { filtered = transactions.filter(t => t.date.startsWith(yearStr)); fixedCostTotal = dailyCost * 365; }
                income = filtered.filter(t => t.type === 'income').reduce((a,c) => a+c.amount, 0); expense = filtered.filter(t => t.type === 'expense').reduce((a,c) => a+c.amount, 0); net = income - expense - fixedCostTotal;
                if(period !== 'year') listData.sort((a,b) => b.id - a.id);
                return { income, expense, fixedCostTotal, net, listData, dailyStats };
            }, [transactions, settings, period, selectedDate, currentMonth]);

            const calendarDays = useMemo(() => getCalendarDays(new Date().getFullYear(), currentMonth), [currentMonth]);
            const handleSave = () => { if (!amount) return; let updated; if (editingId) { updated = transactions.map(t => t.id === editingId ? { ...t, date, amount: parseInt(amount), type, category: cat, note } : t); } else { const newTrans = { id: Date.now(), date: date, amount: parseInt(amount), type, category: cat, note, timestamp: formatTime() }; updated = [newTrans, ...transactions]; } setTransactions(updated); localStorage.setItem(DB_TRANS, JSON.stringify(updated)); resetForm(); };
            const handleDelete = () => { if (!editingId) return; if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) return; const updated = transactions.filter(t => t.id !== editingId); setTransactions(updated); localStorage.setItem(DB_TRANS, JSON.stringify(updated)); resetForm(); };
            const resetForm = () => { setAmount(''); setNote(''); setEditingId(null); setShowAddModal(false); };
            const openEdit = (item) => { setEditingId(item.id); setDate(item.date); setType(item.type); setAmount(item.amount); setCat(item.category); setNote(item.note); setShowAddModal(true); };
            const TrafficBtn = ({ val, label, colorClass }) => (<button onClick={() => updateEnv('traffic', val)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold border transition-all ${currentEnv.traffic === val ? colorClass + ' text-white border-transparent shadow-md' : 'bg-white text-gray-400 border-gray-200'}`}>{label}</button>);

            return (
                <div className="pt-20 min-h-screen bg-slate-50 animate-pop pb-32">
                    <div className="px-4"><BackBtn onClick={goBack} /></div>
                    
                    {/* Sticky Header Wrapper */}
                    <div className="sticky-wrapper px-4 shadow-sm border-b border-slate-100 mb-4">
                        <div className="flex items-center justify-between mb-4"><h2 className="text-2xl font-black text-slate-700">å…§éƒ¨ç‡Ÿé‹</h2></div>
                        <div className="flex justify-between items-center mb-2">
                            <div className="bg-slate-100 p-0.5 rounded-lg inline-flex">{['day', 'month', 'year'].map(p => (<button key={p} onClick={() => setPeriod(p)} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${period === p ? 'bg-sky-500 text-white shadow' : 'text-gray-500'}`}>{p === 'day' ? 'æ—¥' : p === 'month' ? 'æœˆ' : 'å¹´'}</button>))}</div>
                            {period === 'day' && <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="bg-white border border-slate-200 text-sky-600 text-xs font-bold py-1 px-2 rounded-md focus:outline-none" />}
                            {period === 'month' && (<div className="flex items-center space-x-2 bg-white px-2 py-1 rounded-md border border-slate-200"><button onClick={() => setCurrentMonth(p => p===1?12:p-1)} className="text-sky-600"><i className="fa-solid fa-chevron-left text-xs"></i></button><span className="text-xs font-bold text-slate-700 w-8 text-center">{currentMonth}æœˆ</span><button onClick={() => setCurrentMonth(p => p===12?1:p+1)} className="text-sky-600"><i className="fa-solid fa-chevron-right text-xs"></i></button></div>)}
                            <button onClick={() => setShowSettingModal(true)} className="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center"><i className="fa-solid fa-gear"></i></button>
                        </div>
                        {period === 'day' && (<div className="flex items-center gap-2 mb-2"><div className="flex space-x-1 bg-slate-50 p-1 rounded-xl border border-gray-100">{['sunny','cloudy','rainy'].map(w => (<button key={w} onClick={() => updateEnv('weather', w)} className={`w-7 h-7 rounded-lg flex items-center justify-center transition-all ${currentEnv.weather === w ? 'bg-sky-600 text-white shadow' : 'text-gray-300'}`}><i className={`fa-solid fa-${w === 'sunny' ? 'sun' : w === 'cloudy' ? 'cloud' : 'cloud-showers-heavy'} text-xs`}></i></button>))}</div><div className="flex gap-1 flex-1"><TrafficBtn val="slow" label="â„ï¸å†·æ¸…" colorClass="bg-blue-400" /><TrafficBtn val="normal" label="ğŸ™‚æ­£å¸¸" colorClass="bg-yellow-400" /><TrafficBtn val="busy" label="ğŸ”¥çˆ†æ»¿" colorClass="bg-red-500" /></div></div>)}
                        <div className="bg-sky-600 rounded-xl p-3 text-white shadow-lg flex justify-between items-center mb-3"><div><div className="text-[10px] opacity-60 mb-1">æ·¨åˆ©çµé¤˜</div><div className={`text-xl font-black ${stats.net >= 0 ? 'text-white' : 'text-rose-300'}`}>{stats.net > 0 ? '+' : ''}{stats.net.toLocaleString()}</div></div><div className="text-right space-y-1"><div className="text-xs"><span className="opacity-60 mr-2">æ”¶</span> <span className="text-green-300 font-bold">+{stats.income.toLocaleString()}</span></div><div className="text-xs"><span className="opacity-60 mr-2">æ”¯</span> <span className="text-rose-300 font-bold">-{stats.expense.toLocaleString()}</span></div></div></div>
                        <div className="grid grid-cols-2 gap-4"><button onClick={() => {setType('income'); setCat('ç¾é‡‘'); setDate(selectedDate); resetForm(); setShowAddModal(true);}} className="bg-white text-sky-600 border border-sky-100 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center text-sm active:scale-95 transition-transform"><i className="fa-solid fa-plus mr-2"></i> è¨˜é€²å¸³</button><button onClick={() => {setType('expense'); setCat('é€²è²¨'); setDate(selectedDate); resetForm(); setShowAddModal(true);}} className="bg-white text-rose-500 border border-rose-100 py-3 rounded-xl font-bold shadow-sm flex items-center justify-center text-sm active:scale-95 transition-transform"><i className="fa-solid fa-minus mr-2"></i> è¨˜å‡ºå¸³</button></div>
                    </div>

                    <div className="px-4 space-y-3">
                        {period === 'month' && (<div className="mb-4 bg-white rounded-xl p-3 card-shadow border border-slate-100"><div className="flex justify-between items-center mb-2 cursor-pointer" onClick={() => setIsCalExpanded(!isCalExpanded)}><span className="text-xs font-bold text-gray-400">æ—¥æ›†è¦–åœ–</span><i className={`fa-solid fa-chevron-${isCalExpanded ? 'up' : 'down'} text-gray-400 text-xs`}></i></div>{isCalExpanded && (<div className="animate-fade-in"><div className="grid grid-cols-7 gap-1 mb-2 text-center">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <span key={d} className="text-[10px] text-gray-400 font-bold">{d}</span>)}</div><div className="grid grid-cols-7 gap-1">{calendarDays.map((d, i) => { if(!d) return <div key={i}></div>; const s = stats.dailyStats[d.dateStr]; const hasData = s && (s.income > 0 || s.expense > 0); const isSelected = selectedDate === d.dateStr; return ( <div key={i} onClick={() => setSelectedDate(d.dateStr)} className={`aspect-square flex flex-col items-center justify-center rounded-lg cursor-pointer border transition-colors ${isSelected ? 'bg-sky-600 border-sky-600' : 'border-transparent hover:bg-gray-50'}`}> <span className={`text-xs font-bold ${isSelected ? 'text-white' : 'text-gray-500'}`}>{d.day}</span> <div className={`w-1.5 h-1.5 rounded-full mt-1 ${hasData ? 'bg-green-500' : 'opacity-0'}`}></div> </div> ); })}</div></div>)}</div>)}
                        <h3 className="font-bold text-slate-700 text-xs border-l-4 border-sky-500 pl-2 mb-2">æµæ°´å¸³æ˜ç´° ({selectedDate})</h3>
                        {stats.listData.length === 0 ? (<div className="text-center py-10 opacity-40"><i className="fa-solid fa-clipboard-list text-3xl mb-2 text-gray-300"></i><p className="text-xs text-gray-400">å°šç„¡è³‡æ–™</p></div>) : (stats.listData.map((item, idx) => (<div key={idx} onClick={() => openEdit(item)} className="bg-white p-3 rounded-lg flex justify-between items-center shadow-sm border-l-2 border-slate-100 active:bg-gray-50 cursor-pointer"><div className="flex items-center"><div className={`w-8 h-8 rounded-full flex items-center justify-center mr-3 ${item.type === 'income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}><i className={`fa-solid ${item.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up'} text-xs`}></i></div><div><div className="flex items-center gap-2"><span className="font-bold text-slate-700 text-sm">{item.category}</span><span className="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">{item.timestamp?.slice(0,5)}</span></div>{item.note && <p className="text-xs text-gray-400 truncate max-w-[150px]">{item.note}</p>}</div></div><span className={`font-bold text-base ${item.type === 'income' ? 'text-green-600' : 'text-red-600'}`}>{item.type === 'income' ? '+' : '-'}{item.amount.toLocaleString()}</span></div>)))}
                    </div>
                    {/* Modals omitted for brevity but functionality logic is in handleSave */}
                    {showAddModal && (<div className="fixed inset-0 bg-slate-900/50 z-[200] flex items-end sm:items-center justify-center sm:p-4 modal-overlay"><div className="bg-white rounded-t-2xl sm:rounded-xl w-full max-w-sm p-6 shadow-2xl animate-fade-in"><div className="flex justify-between items-center mb-6"><h3 className="font-black text-xl text-slate-700">{editingId ? 'ç·¨è¼¯ç´€éŒ„' : (type === 'income' ? 'è¨˜ä¸€ç­†é€²å¸³' : 'è¨˜ä¸€ç­†å‡ºå¸³')}</h3>{editingId && <button onClick={handleDelete} className="text-rose-500 font-bold text-sm"><i className="fa-solid fa-trash mr-1"></i>åˆªé™¤</button>}</div><div className="space-y-5"><input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full bg-slate-100 p-3 rounded-lg font-bold text-slate-700" /><div className="relative"><span className="absolute left-0 top-2 text-2xl font-bold text-slate-700">$</span><input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full pl-6 text-4xl font-black border-b-2 border-slate-200 py-2 focus:outline-none text-slate-700 placeholder-gray-200" placeholder="0" autoFocus /></div><div className="flex flex-wrap gap-2">{type === 'income' ? ['ç¾é‡‘', 'åˆ·å¡', 'å¤–é€å¹³å°', 'å…¶ä»–'].map(c => <button key={c} onClick={() => setCat(c)} className={`px-4 py-2 rounded-full text-xs font-bold border transition-colors ${cat === c ? 'bg-sky-600 text-white' : 'bg-white text-gray-500 hover:bg-gray-50'}`}>{c}</button>) : ['é€²è²¨', 'äººäº‹', 'é›œæ”¯', 'ä¿®ç¹•', 'æˆ¿ç§Ÿ'].map(c => <button key={c} onClick={() => setCat(c)} className={`px-4 py-2 rounded-full text-xs font-bold border transition-colors ${cat === c ? 'bg-sky-600 text-white' : 'bg-white text-gray-500 hover:bg-gray-50'}`}>{c}</button>)}</div><input type="text" value={note} onChange={e => setNote(e.target.value)} className="w-full bg-gray-50 rounded-lg p-3 text-sm focus:outline-none" placeholder="å‚™è¨» (é¸å¡«)..." /><div className="flex gap-3 mt-4"><button onClick={() => setShowAddModal(false)} className="flex-1 py-4 text-gray-500 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button><button onClick={handleSave} className="flex-1 py-4 bg-sky-600 text-white rounded-xl font-bold shadow-lg">ç¢ºèª</button></div></div></div></div>)}
                    {showSettingModal && (<div className="fixed inset-0 bg-slate-900/50 z-[200] flex items-center justify-center p-4 modal-overlay"><div className="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl"><h3 className="font-bold text-lg mb-2 text-slate-700">æ—¥å‡ç‡Ÿé‹æˆæœ¬</h3><p className="text-xs text-gray-400 mb-4">å‹¾é¸åŒ…å«é …ç›®ï¼Œä¸¦è¼¸å…¥æ¯æ—¥ç¸½æ”¤æé¡ (é è¨­ç‚º0)</p><div className="flex flex-wrap gap-2 mb-6">{costOptions.map(item => (<button key={item} onClick={() => toggleCostItem(item)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors ${selectedCostItems.includes(item) ? 'bg-sky-600 text-white border-sky-600' : 'bg-white text-gray-400 border-gray-200'}`}>{selectedCostItems.includes(item) && <i className="fa-solid fa-check mr-1"></i>}{item}</button>))}</div><div className="relative"><span className="absolute left-0 top-3 text-xl font-bold text-slate-700">$</span><input type="number" value={tempFixedCost} onChange={e => setTempFixedCost(e.target.value)} className="w-full pl-6 text-3xl font-black border-b-2 border-slate-700 py-2 mb-6 focus:outline-none text-slate-700" placeholder="0" /></div><div className="flex gap-3"><button onClick={() => setShowSettingModal(false)} className="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-lg">å–æ¶ˆ</button><button onClick={() => { saveSettings({...settings, dailyFixedCost: parseInt(tempFixedCost) || 0, costItems: selectedCostItems}); setShowSettingModal(false); }} className="flex-1 py-3 bg-sky-600 text-white rounded-lg font-bold">å„²å­˜</button></div></div></div>)}
                </div>
            );
        };

        const TimerPage = ({ goBack, activeTimer, startTimer, stopTimer }) => (
            <div className="pt-20 px-6 min-h-screen bg-white animate-pop">
                <BackBtn onClick={goBack} />
                <div className="flex items-center mb-10"><h2 className="text-2xl font-black text-slate-700">æš«é›¢æé†’</h2></div>
                <div className="grid grid-cols-1 gap-6">
                    {[10, 15, 20].map(m => {
                        const isActive = activeTimer && activeTimer.minutes === m;
                        return (<button key={m} onClick={() => isActive ? stopTimer() : startTimer(m)} className={`relative h-20 rounded-2xl overflow-hidden cursor-pointer active:scale-95 transition-all flex items-center justify-center w-full shadow-sm border ${isActive ? 'bg-orange-500 border-orange-500 animate-pulse' : 'bg-orange-50 border-orange-100'}`}>{isActive && <div className="absolute left-0 top-0 bottom-0 bg-white/20 z-0 animate-progress" style={{ animationDuration: `${m * 60}s`, width: '100%' }}></div>}<div className="relative z-10 flex flex-col items-center"><i className="fa-solid fa-clock text-2xl mb-1 text-orange-400"></i><span className={`font-black text-xl ${isActive ? 'text-white' : 'text-orange-500'}`}>{m} <span className="text-sm">MIN</span></span></div></button>);
                    })}
                    {activeTimer && <div className="text-center text-orange-500 font-bold mt-4 animate-bounce">è¨ˆæ™‚é€²è¡Œä¸­...</div>}
                </div>
            </div>
        );

        const NotePage = ({ goBack, logs, setLogs }) => {
            const [input, setInput] = useState('');
            const { isListening, startListening } = useVoiceInput((text) => setInput(prev => prev + text));
            const add = () => { if(!input.trim()) return; const n={id:Date.now(), date:getToday(), timestamp:formatTime(), text:input}; const u=[n,...logs]; setLogs(u); localStorage.setItem(DB_LOGS, JSON.stringify(u)); setInput(''); };
            const del = (id) => { const u=logs.filter(l=>l.id!==id); setLogs(u); localStorage.setItem(DB_LOGS, JSON.stringify(u)); };
            return (
                <div className="pt-20 px-6 min-h-screen bg-white animate-pop">
                    <BackBtn onClick={goBack} />
                    <div className="flex items-center mb-6"><h2 className="text-2xl font-black text-slate-700">ç‡Ÿé‹ç­†è¨˜</h2></div>
                    <div className="flex gap-2 mb-6"><input value={input} onChange={e=>setInput(e.target.value)} placeholder="è¨˜äº‹..." className="flex-1 bg-slate-50 rounded-xl px-4 py-3 text-sm focus:outline-none" /><button onClick={startListening} className="w-10 rounded-xl border border-slate-200 text-slate-400"><i className="fa-solid fa-microphone"></i></button><button onClick={add} className="w-12 rounded-xl bg-slate-600 text-white"><i className="fa-solid fa-plus"></i></button></div>
                    <div className="space-y-4">{logs.map(l => (<div key={l.id} className="border-l-4 border-yellow-400 bg-yellow-50 pl-3 py-2 pr-2 rounded-r-lg flex justify-between group"><div><div className="text-[10px] text-yellow-700 font-mono mb-0.5">{l.date} {l.timestamp}</div><div className="text-sm text-slate-800">{l.text}</div></div><button onClick={() => del(l.id)} className="text-slate-300 opacity-0 group-hover:opacity-100"><i className="fa-solid fa-times"></i></button></div>))}</div>
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = useState('home');
            const [transactions, setTransactions] = useState([]);
            const [logs, setLogs] = useState([]);
            const [settings, setSettings] = useState({ dailyFixedCost: 0, costItems: [] });
            const [envData, setEnvData] = useState({});
            const [activeTimer, setActiveTimer] = useState(null);

            useEffect(() => {
                const t = localStorage.getItem(DB_TRANS); if(t) setTransactions(JSON.parse(t));
                const l = localStorage.getItem(DB_LOGS); if(l) setLogs(JSON.parse(l));
                const s = localStorage.getItem(DB_SETTINGS); if(s) setSettings(JSON.parse(s));
                const e = localStorage.getItem(DB_ENV); if(e) setEnvData(JSON.parse(e));
            }, []);
            const saveSettings = (n) => { setSettings(n); localStorage.setItem(DB_SETTINGS, JSON.stringify(n)); };
            const startTimer = (m) => { setActiveTimer({ minutes: m, startTime: Date.now() }); };
            const stopTimer = () => { setActiveTimer(null); };
            useEffect(() => {
                let interval;
                if (activeTimer) {
                    interval = setInterval(() => {
                        const elapsed = (Date.now() - activeTimer.startTime) / 1000;
                        if (elapsed >= activeTimer.minutes * 60) {
                            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                            alert('è½‰å ´æ™‚é–“åˆ°ï¼'); setActiveTimer(null);
                        }
                    }, 1000);
                } return () => clearInterval(interval);
            }, [activeTimer]);
            const tasksCount = useMemo(() => { const t = localStorage.getItem(DB_TASKS); if(!t) return 0; return JSON.parse(t).filter(i => i.tab === 'today' && !i.done).length; }, [page]); 
            const goHome = () => setPage('home');

            return (
                <div className="min-h-screen pb-safe-bottom bg-slate-50">
                    <Header />
                    <div className="h-screen pt-14 pb-20">
                        {page === 'home' && <DashboardGrid setPage={setPage} tasksCount={tasksCount} />}
                        {page === 'todo' && <TodoPage goBack={goHome} />}
                        {page === 'ops' && <OperationsPage goBack={goHome} transactions={transactions} setTransactions={setTransactions} settings={settings} saveSettings={saveSettings} envData={envData} setEnvData={setEnvData} />}
                        {page === 'timer' && <TimerPage goBack={goHome} activeTimer={activeTimer} startTimer={startTimer} stopTimer={stopTimer} />}
                        {page === 'note' && <NotePage goBack={goHome} logs={logs} setLogs={setLogs} />}
                        {page === 'ai' && (<div className="pt-20 px-6 text-center animate-pop"><div className="w-24 h-24 bg-white rounded-full mx-auto flex items-center justify-center shadow-soft mb-6 border-4 border-sky-50 text-sky-500 text-4xl"><i className="fa-solid fa-user-tie"></i></div><h2 className="text-xl font-black text-slate-700 mb-2">AI æ™ºæ…§é¡§å•æœå‹™</h2><div className="bg-sky-50 text-sky-500 px-3 py-1 rounded-full text-[10px] font-bold mb-6 inline-block">PLANNING</div><p className="text-sm text-slate-500 max-w-xs mx-auto">æœ¬åŠŸèƒ½ç‚ºé€²éšè¨‚é–±æœå‹™ï¼Œç›®å‰å°šåœ¨è¦åŠƒä¸­ã€‚</p><BackBtn onClick={goHome} /></div>)}
                    </div>
                    {page === 'home' && (<div className="fixed bottom-8 left-6 right-6 glass-nav h-16 rounded-2xl flex items-center justify-around px-2 z-50"><button onClick={() => setPage('home')} className="flex flex-col items-center gap-1 text-sky-600 w-full"><i className="fa-solid fa-grid-2 text-lg"></i><span className="text-[10px] font-bold">æˆ°æƒ…</span></button><button onClick={() => setPage('ops')} className="flex flex-col items-center gap-1 text-slate-400 w-full hover:text-sky-600"><i className="fa-solid fa-chart-pie text-lg"></i><span className="text-[10px] font-bold">ç‡Ÿé‹</span></button><button onClick={() => setPage('ai')} className="flex flex-col items-center gap-1 text-slate-400 w-full hover:text-sky-600"><i className="fa-solid fa-user-tie text-lg"></i><span className="text-[10px] font-bold">ç§˜æ›¸</span></button></div>)}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw-v6.3.js')); }
    </script>
</body>
</html>