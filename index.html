<!-- 檔名：index.html -->
<!-- 版本：v6.0.A (Modern UI + ToDo + PWA Fix) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SEAFOOD.BOSS</title>
    
    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F8FAFC"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sky: { 500: '#0EA5E9', 600: '#0284C7' },  // 主色：淺海藍
                        slate: { 50: '#F8FAFC', 100: '#F1F5F9', 400: '#94A3B8', 700: '#334155' }, // 底色
                        rose: { 50: '#FFF1F2', 500: '#F43F5E' },  // 點綴：粉/紅
                        orange: { 400: '#FB923C', 500: '#F97316' }, // 點綴：橘
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(14, 165, 233, 0.3)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8FAFC;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            user-select: none;
        }
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 毛玻璃特效 */
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.3); }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(241, 245, 249, 0.5); }
        
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Database Keys ---
        const DB_TASKS = 'sb_tasks_v1';
        const DB_TRANS = 'sf_transactions';
        const DB_LOGS = 'sf_logs';
        const DB_SETTINGS = 'sf_settings';

        // --- Utils ---
        const getToday = () => new Date().toISOString().split('T')[0];
        const formatTime = () => new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute:'2-digit' });

        // --- Components ---

        // 1. Header (Floating & Minimal)
        const Header = () => (
            <div className="fixed top-0 left-0 right-0 z-50 glass safe-top">
                <div className="h-14 flex items-center justify-between px-5">
                    <div className="flex items-center gap-2">
                        <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-sky-500 to-sky-600 flex items-center justify-center text-white shadow-glow">
                            <i className="fa-solid fa-fish text-sm"></i>
                        </div>
                        <h1 className="font-bold text-slate-700 tracking-tight text-lg">SEAFOOD<span className="text-sky-500">.BOSS</span></h1>
                    </div>
                    <div className="text-[10px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-full">v6.0.A</div>
                </div>
            </div>
        );

        // 2. To-Do Card (Modern Style)
        const TodoCard = () => {
            const [tasks, setTasks] = useState([]);
            const [tab, setTab] = useState('today'); // today | tomorrow
            const [input, setInput] = useState('');
            
            useEffect(() => {
                const saved = localStorage.getItem(DB_TASKS);
                if (saved) {
                    let parsed = JSON.parse(saved);
                    // 跨日邏輯：如果有昨日的 tomorrow 任務，轉為今日
                    const lastDate = localStorage.getItem('sb_last_date');
                    const today = getToday();
                    if (lastDate !== today) {
                        parsed = parsed.map(t => t.tab === 'tomorrow' ? { ...t, tab: 'today' } : t);
                        localStorage.setItem('sb_last_date', today);
                    }
                    setTasks(parsed);
                } else {
                    localStorage.setItem('sb_last_date', getToday());
                }
            }, []);

            const saveTasks = (newTasks) => {
                setTasks(newTasks);
                localStorage.setItem(DB_TASKS, JSON.stringify(newTasks));
            };

            const addTask = (text) => {
                if (!text.trim()) return;
                const newTask = { id: Date.now(), text, done: false, tab, urgent: text.includes('!') || text.includes('急') };
                saveTasks([newTask, ...tasks]);
                setInput('');
            };

            const toggleTask = (id) => {
                const updated = tasks.map(t => t.id === id ? { ...t, done: !t.done } : t);
                // 已完成的沉底排序
                updated.sort((a, b) => a.done === b.done ? 0 : a.done ? 1 : -1);
                saveTasks(updated);
            };

            const deleteTask = (id) => {
                if(confirm('刪除此任務？')) saveTasks(tasks.filter(t => t.id !== id));
            };

            const chips = ['叫貨', '匯款', '排班', '客訴', '維修'];
            const currentTasks = tasks.filter(t => t.tab === tab);

            return (
                <div className="bg-white rounded-2xl p-5 shadow-soft mb-4 animate-slide-up">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg font-bold text-slate-700">今日重點</h2>
                        <div className="bg-slate-100 p-1 rounded-lg flex text-xs font-bold">
                            <button onClick={() => setTab('today')} className={`px-3 py-1.5 rounded-md transition-all ${tab === 'today' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-400'}`}>今日</button>
                            <button onClick={() => setTab('tomorrow')} className={`px-3 py-1.5 rounded-md transition-all ${tab === 'tomorrow' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-400'}`}>明日</button>
                        </div>
                    </div>

                    <div className="space-y-3 min-h-[120px]">
                        {currentTasks.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-slate-300 py-8">
                                <i className="fa-regular fa-calendar-check text-2xl mb-2"></i>
                                <span className="text-xs">清單空空如也，完美的開始</span>
                            </div>
                        ) : (
                            currentTasks.map(t => (
                                <div key={t.id} className="flex items-center group">
                                    <button onClick={() => toggleTask(t.id)} className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors mr-3 shrink-0 ${t.done ? 'bg-sky-500 border-sky-500' : 'border-slate-300'}`}>
                                        {t.done && <i className="fa-solid fa-check text-white text-[10px]"></i>}
                                    </button>
                                    <span className={`flex-1 text-sm font-medium transition-colors ${t.done ? 'text-slate-300 line-through' : 'text-slate-700'}`}>
                                        {t.text.replace('!', '').replace('急', '')}
                                    </span>
                                    {t.urgent && !t.done && <span className="text-[10px] font-bold text-rose-500 bg-rose-50 px-1.5 py-0.5 rounded ml-2">急</span>}
                                    <button onClick={() => deleteTask(t.id)} className="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <i className="fa-solid fa-trash text-xs"></i>
                                    </button>
                                </div>
                            ))
                        )}
                    </div>

                    <div className="mt-4 pt-4 border-t border-slate-50">
                        <div className="flex gap-2 mb-3 overflow-x-auto no-scrollbar pb-1">
                            {chips.map(c => (
                                <button key={c} onClick={() => setInput(prev => prev + c + ' ')} className="px-3 py-1 rounded-full bg-slate-50 text-slate-500 text-[10px] font-bold border border-slate-100 whitespace-nowrap active:scale-95 transition-transform">{c}</button>
                            ))}
                        </div>
                        <div className="flex gap-2">
                            <input type="text" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && addTask(input)} placeholder="輸入任務..." className="flex-1 bg-slate-50 rounded-xl px-4 py-2.5 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-100 transition-shadow" />
                            <button onClick={() => addTask(input)} className="w-10 h-10 rounded-xl bg-sky-500 text-white flex items-center justify-center shadow-lg shadow-sky-200 active:scale-95 transition-transform"><i className="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Stats & Quick Action (Pulse & Flash)
        const StatsBlock = ({ transactions, onQuickAdd }) => {
            const today = getToday();
            const todayNet = useMemo(() => {
                const todays = transactions.filter(t => t.date === today);
                const inc = todays.filter(t => t.type === 'income').reduce((a,c) => a+c.amount, 0);
                const exp = todays.filter(t => t.type === 'expense').reduce((a,c) => a+c.amount, 0);
                return inc - exp;
            }, [transactions, today]);

            return (
                <div className="grid grid-cols-2 gap-4 mb-4">
                    {/* Left: Net Income */}
                    <div className="bg-white p-4 rounded-2xl shadow-soft flex flex-col justify-between h-32 relative overflow-hidden">
                        <div className="z-10">
                            <div className="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">今日淨利</div>
                            <div className={`text-2xl font-black ${todayNet >= 0 ? 'text-sky-600' : 'text-rose-500'}`}>
                                {todayNet > 0 ? '+' : ''}{todayNet.toLocaleString()}
                            </div>
                        </div>
                        <div className="z-10 flex items-center gap-1">
                            <div className={`w-2 h-2 rounded-full ${todayNet >= 0 ? 'bg-orange-400' : 'bg-rose-400'} animate-pulse`}></div>
                            <span className="text-[10px] text-slate-400 font-bold">Live Update</span>
                        </div>
                        {/* Decor */}
                        <i className="fa-solid fa-chart-line absolute -bottom-2 -right-2 text-6xl text-slate-50 opacity-50 transform -rotate-12"></i>
                    </div>

                    {/* Right: Quick Action */}
                    <button onClick={onQuickAdd} className="bg-white p-4 rounded-2xl shadow-soft flex flex-col items-center justify-center h-32 active:scale-95 transition-transform group relative overflow-hidden">
                        <div className="absolute inset-0 bg-sky-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="w-12 h-12 rounded-full bg-gradient-to-tr from-sky-500 to-sky-400 flex items-center justify-center text-white shadow-glow mb-2 group-active:scale-110 transition-transform">
                            <i className="fa-solid fa-plus text-xl"></i>
                        </div>
                        <span className="text-xs font-bold text-slate-600">快速記帳</span>
                    </button>
                </div>
            );
        };

        // 4. Operations Log (Refined)
        const LogCard = ({ logs, setLogs }) => {
            const [input, setInput] = useState('');
            const addLog = () => {
                if(!input.trim()) return;
                const newLog = { id: Date.now(), date: getToday(), time: formatTime(), text: input };
                const updated = [newLog, ...logs];
                setLogs(updated);
                localStorage.setItem(DB_LOGS, JSON.stringify(updated));
                setInput('');
            };
            const deleteLog = (id) => {
                const updated = logs.filter(l => l.id !== id);
                setLogs(updated);
                localStorage.setItem(DB_LOGS, JSON.stringify(updated));
            };

            return (
                <div className="bg-white rounded-2xl p-5 shadow-soft mb-24">
                    <h3 className="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                        <i className="fa-solid fa-note-sticky text-orange-400"></i> 營運筆記
                    </h3>
                    <div className="flex gap-2 mb-4">
                        <input value={input} onChange={e => setInput(e.target.value)} placeholder="隨手記..." className="flex-1 bg-slate-50 rounded-lg px-3 py-2 text-sm focus:outline-none border border-transparent focus:border-sky-200" />
                        <button onClick={addLog} className="w-9 h-9 rounded-lg bg-orange-400 text-white shadow-sm active:scale-95"><i className="fa-solid fa-paper-plane text-xs"></i></button>
                    </div>
                    <div className="space-y-3 pl-2 border-l-2 border-slate-100">
                        {logs.slice(0, 5).map(l => (
                            <div key={l.id} className="flex justify-between items-start group">
                                <div className="text-xs text-slate-600 leading-relaxed">
                                    <span className="text-[10px] text-slate-400 font-mono mr-2">{l.time}</span>
                                    {l.text}
                                </div>
                                <button onClick={() => deleteLog(l.id)} className="text-slate-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 px-2"><i className="fa-solid fa-times"></i></button>
                            </div>
                        ))}
                        {logs.length === 0 && <div className="text-[10px] text-slate-300 italic py-2">尚無筆記</div>}
                    </div>
                </div>
            );
        };

        // 5. Bottom Nav (Floating Capsule)
        const BottomNav = ({ page, setPage }) => (
            <div className="fixed bottom-6 left-1/2 -translate-x-1/2 glass-nav px-6 py-3 rounded-full shadow-2xl flex gap-8 z-50">
                <button onClick={() => setPage('home')} className={`flex flex-col items-center gap-1 transition-colors ${page === 'home' ? 'text-sky-600' : 'text-slate-400'}`}>
                    <i className="fa-solid fa-layer-group text-lg"></i>
                    <span className="text-[9px] font-bold">戰情</span>
                </button>
                <button onClick={() => setPage('ops')} className={`flex flex-col items-center gap-1 transition-colors ${page === 'ops' ? 'text-sky-600' : 'text-slate-400'}`}>
                    <i className="fa-solid fa-calculator text-lg"></i>
                    <span className="text-[9px] font-bold">營運</span>
                </button>
                <button onClick={() => setPage('ai')} className={`flex flex-col items-center gap-1 transition-colors ${page === 'ai' ? 'text-sky-600' : 'text-slate-400'}`}>
                    <i className="fa-solid fa-robot text-lg"></i>
                    <span className="text-[9px] font-bold">秘書</span>
                </button>
            </div>
        );

        // --- Pages Wrapper ---
        const App = () => {
            const [page, setPage] = useState('home');
            const [transactions, setTransactions] = useState([]);
            const [logs, setLogs] = useState([]);

            useEffect(() => {
                const t = localStorage.getItem(DB_TRANS); if(t) setTransactions(JSON.parse(t));
                const l = localStorage.getItem(DB_LOGS); if(l) setLogs(JSON.parse(l));
            }, []);

            // Quick Add Modal Logic (Simplified for Demo)
            const handleQuickAdd = () => {
                // 直接跳轉到 Ops 頁面並打開記帳 (這裡簡化為跳轉)
                setPage('ops');
            };

            return (
                <div className="min-h-screen pb-safe-bottom">
                    <Header />
                    
                    {/* Content Area */}
                    <div className="pt-20 px-5 animate-fade-in">
                        {page === 'home' && (
                            <>
                                <TodoCard />
                                <StatsBlock transactions={transactions} onQuickAdd={handleQuickAdd} />
                                <LogCard logs={logs} setLogs={setLogs} />
                            </>
                        )}

                        {page === 'ops' && (
                            <div className="text-center py-20">
                                <i className="fa-solid fa-calculator text-4xl text-sky-200 mb-4"></i>
                                <h2 className="text-slate-500 font-bold">營運報表介面</h2>
                                <p className="text-xs text-slate-400 mt-2">將沿用 v4.8 邏輯但套用新風格 (待續...)</p>
                                {/* 註：為了不讓程式碼過長，這裡先保留佔位，您的舊有記帳邏輯完全可以搬過來 */}
                            </div>
                        )}

                        {page === 'ai' && (
                            <div className="text-center py-20">
                                <div className="w-20 h-20 bg-white rounded-full mx-auto flex items-center justify-center shadow-soft mb-6">
                                    <i className="fa-solid fa-user-tie text-3xl text-sky-500"></i>
                                </div>
                                <h2 className="text-lg font-bold text-slate-700">AI 智慧顧問</h2>
                                <p className="text-xs text-slate-400 mt-2">PLANNING PROGESS</p>
                            </div>
                        )}
                    </div>

                    <BottomNav page={page} setPage={setPage} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Register SW
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw-v4.8.js');
            });
        }
    </script>
</body>
</html>